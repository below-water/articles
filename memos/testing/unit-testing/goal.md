# 単体テストの目標

## 単体テストの必要性

時間対効果が大事。
良い単体テストが書けていると、ビジネス要求にも迅速に対応できる。
良くない単体テストの場合は、効果が小さいだけでなく、保守するのにも時間がかかってしまう。
膨大なテストが原因で開発の時間が少なくなり、その結果バグが発生することもある。
労力に見合った結果を引き出す単体テストを作成することが大事。

## 単体テストと設計との関係

単体テストのプラクティスを実施すれば、設計はより優れたものになる。
単体テストが作成しづらいのであれば、そのコードは密結合である可能性が高い。
コードが疎結合であっても、良い設計であるとは限らない。

## 単体テストの目標

単体テストの目標は、「ソフトウェア開発プロジェクトの成長を持続可能なものにする」こと。
テストがないプロジェクトは、初めは順調に成長するが、徐々に鈍化していく。
開発スピードが急に落ちる現象はソフトウェアエントロピー（無秩序の量）の増加によって起こる。

コードを変更したあとリファクタリングをしないとエントロピーが増加し、バグがバグを生むことに繋がる。
しかし、テストがあればバグを検出することができる。

## テストの質を良くするもの、悪くするもの

テストの質が悪い場合、初めのうちは効果はあるが、時間が経つにつれテストがない場合とかかる労力が変わらなくなっていく。

テストスイートとは、目的や対象ごとにテストケースを集めたもの。

ソフトウェアの質を向上するテストケースもあれば、逆もある。
テストケースの質が悪ければ、

- バグなのに失敗しない
- バグでないのに失敗する
- テストの実行時間がかかる

時間対効果を考慮する必要がある。
テストが増えることによる時間コストは、以下の作業によって増加する。

- プロダクションコードのリファクタリングに伴うテストコードのリファクタリング
- テストの実行時間
- テストが間違って失敗した際にその対処をすること
- プロダクションコードを理解するためにテストコードを読むこと

単にテストケースを増やせばいいということではない。
コードは資産ではなく、負債である。
テストコードも同じであり、プロダクションコードの一部として見なくてはならない。

## 網羅率とテストスイートの質との関係

網羅率とは、テストケースが実行するプロダクションコードの割合。

網羅率は良いテストの必要条件である。

コード網羅率 = 実行されたコードの行数 / 総行数
コード網羅率は、if文を三項演算子に変えただけで高くなってしまう。

分岐網羅率 = 経由された経路の数 / 分岐経路の総数
コード網羅率よりも正確である。

以下の点から、網羅率を使ってテストスイートの質を評価することはできない。

- 網羅率からは実際にテスト対象のコードが検証されたかを保証できないため
- 使用するライブラリのコードは計測の対象から外れるため

つまり、網羅率からはテストが網羅的に行われているかを知ることはできない。

## テストスイートを良くするもの

テストスイートを評価するには、テストケースを1つずつ段階的に評価するしかない。
結局、テストスイートの評価は個人的な判断に基づいて行われる。

良いテストスイートの特徴は、

- テストが開発サイクルの中に組み込まれている
- 特に重要な部分がテスト対象になっている
- 最小限の保守コストで最大限の価値を生み出すようになっている

### 特に重要な部分がテスト対象になっている

コードベースのすべての部分が単体テストをする価値を持っているわけではない。

アプリケーションにおいて核となる部分はビジネスロジックを含む部分、つまり、ドメインモデルである。
ドメインモデルではないコードでも、複雑で重要なアルゴリズムが含まれている場合や、
統合テストでシステム全体がどのように機能するか検証する場合は、そのテストケースに価値がないことはない。

単体テストにかける労力をドメインモデルにのみ向けるためには、コードベースの本質ではない部分から隔離しなければならない。

### 最小限の保守コストで最大限の価値を生み出すようになっている

これを実現するには、テストスイートに含めるテストケースを、コスパの高いものだけにする必要がある。
これを実現するには、

- 価値のあるテストケース、ないテストケースを認識できること
- 価値のあるテストケースを作成できること

価値のあるテストケースを認識するためには、テストケースの価値を評価するための基準となる枠組みを知っていなければならない。
価値のあるテストケースを作成するためには、これに加えて、設計のテクニックも理解していなければならない。

テスト対象のコードがしっかりと設計できていなければ、価値のあるテストは作成できない。
