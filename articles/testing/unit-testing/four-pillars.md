# 良い単体テストを構成する4本の柱

優れた単体テストのテストスイートは、最小限の保守コストで最大限の価値を生み出す。
これを実現するためには、価値のあるテストケースを認識できなければならない。
テストケースを分析するのに使う基準となる枠組みであり、良い単体テストを構成する4本の柱は以下である。

- リグレッションに対する保護
- リファクタリングへの耐性
- 迅速なフィードバック
- 保守のしやすさ

## リグレッションに対する保護

以下の観点に着目すると、より多くのリグレッションを防ぐことができる。

- テスト時に実行されるプロダクションコードの量
  - 量が増えるほど、リグレッションが見つかる可能性は高くなる
- テスト対象のコードの複雑さ
  - ビジネスロジックのコードは複雑なほど重要になる
- テスト対象のコードのドメインにおける重要性
  - ビジネス的に重要な機能ほど、バグによる被害も大きい

重要でないコードをテストする価値はほとんどない。

アプリケーションに対する影響が大きいため、ライブラリやフレームワークのコードも考慮する必要がある。

## リファクタリングへの耐性

偽陽性(false positive)とは、テスト対象のコードには問題がないのにテストが失敗すること。
プロダクションコードをリファクタリングする際に起こる。
リファクタリングへの耐性とは、リファクタリングを行なっても偽陽性が生まれにくい性質のこと(と本書では呼ぶ)。

リファクタリングへの耐性があるか評価するには、そのテストケースを実行することでどのくらいの偽陽性が発生するのか計測する。

単体テストによって、

- バグを検出できる
- プロダクションコードを変更してもテストを実行できるので、リファクタリングをしようと思える

しかし、偽陽性に対して注意を払わないと、テストが失敗することに慣れてしまいテスト結果を重要視しなくなる。

## 偽陽性を引き起こす原因

偽陽性を防ぐには、検証する対象を実装の詳細ではなく、最終的な結果(観測可能な振る舞い)のみに絞る。
テストケースを作成する際は、それが問題領域に関する物語(Story)を伝えているかを意識する。
検証対象が実装の詳細の場合、リファクタリングするとテストが壊れる。

## コードの正確性とテストの結果との関係

|              |      | 実際の振る舞い                              |                                               |
| ------------ | ---- | ------------------------------------------- | --------------------------------------------- |
|              |      | 正しい                                      | 間違い                                        |
| テストの結果 | 成功 | 真陰性(正しい推断)                          | 偽陰性(第二種過誤) リグレッションに対する保護 |
|              | 失敗 | 偽陽性(第一種過誤) リファクタリングへの耐性 | 真陽性(正しい推断)                            |

偽陽性や偽陰性の可能性が低ければ、そのテストは正確性が高い。
つまり、リグレッションに対する保護とリファクタリングへの耐性を備えることは、テストの正確性を高くする。

テストの正確性を評価する別の方法に信号対ノイズ比がある。
テストの正確性 = 信号(検出されたバグの数) / ノイズ(嘘の警告が発せられた数)

## 迅速なフィードバック

テストを速やかに行うようになると、用意されるテストケースも増え、テストの頻度も高くなる。
そして、フィードバックを得てから改善するまでの時間も劇的に短くなり、バグをすぐに検出できるようになる。
